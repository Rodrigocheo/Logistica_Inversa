<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Komatsu – RF Escáner</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 18px; padding: 18px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .logo { display:flex; align-items:center; gap:10px; margin: 4px 0 14px; }
    .logo img { height: 26px; }
    .brand { font-weight: 900; letter-spacing: .5px; color:#053b8d; }
    label { display:block; font-size: 13px; color:#333; margin: 12px 0 6px; }
    input, button { width:100%; padding: 16px 14px; border:1px solid #d8dbe2; border-radius:14px; font-size:18px; box-sizing: border-box; }
    input:disabled { background:#f2f2f2; }
    button { background:#053b8d; color:#fff; border:none; font-weight:700; letter-spacing:.3px; height:56px; }
    button:disabled { opacity:.55; }
    .msg { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; padding: 12px 16px; border-radius: 12px; font-size:14px; display:none; box-shadow: 0 8px 24px rgba(0,0,0,.12); }
    .ok { background:#0a6b2c; color:#fff; }
    .err { background:#b42318; color:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="#053b8d" aria-hidden="true"><path d="M12 2l3.5 7.1L23 9l-5.5 5.1L19 22l-7-4-7 4 1.5-7.9L1 9l7.5-.9z"/></svg>
      <div class="brand">KOMATSU · RF Escáner</div>
    </div>

    <div class="card">
      <form id="frm" autocomplete="off">
        <label for="codigo">Producto (Código)</label>
        <input id="codigo" placeholder="Escanee o escriba" autofocus/>

        <label for="descripcion">Descripción</label>
        <input id="descripcion" placeholder="DESCONOCIDO" disabled />

        <label for="cantidad">Cantidad</label>
        <input id="cantidad" type="number" min="1" value="1"/>

        <button id="btnGuardar" type="submit">Guardar</button>
      </form>
    </div>

    <div id="toastOK" class="msg ok"></div>
    <div id="toastERR" class="msg err"></div>

    <script>
      const API_BASE = ""; // Mismo dominio que la API en Render
      const $ = (id) => document.getElementById(id);

      function toast(el, text){ el.textContent = text; el.style.display = 'block'; setTimeout(()=> el.style.display='none', 2000); }

      async function fetchJSON(url){
        const res = await fetch(url);
        if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return res.json();
      }

      async function postJSON(url, body){
        const res = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data?.ok === false){ throw new Error(data?.error || res.statusText); }
        return data;
      }

      async function autocompletarDescripcion(codigo){
        if(!codigo){ $('descripcion').value = ''; return; }
        try{
          const d = await fetchJSON(`${API_BASE}/producto/${encodeURIComponent(codigo)}`);
          $('descripcion').value = d?.descripcion || 'DESCONOCIDO';
        }catch(e){ $('descripcion').value = 'DESCONOCIDO'; }
      }

      $('codigo').addEventListener('blur', (e)=> autocompletarDescripcion(e.target.value.trim()));

      $('frm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const codigo = $('codigo').value.trim();
        const cantidad = parseInt($('cantidad').value, 10) || 0;
        if(!codigo || cantidad < 1){ toast($('toastERR'), 'Completa código y cantidad válidos.'); return; }
        try{
          const data = await postJSON(`${API_BASE}/scan`, { codigo, cantidad, usuario: null });
          const s = data?.saved || {};
          toast($('toastOK'), `Guardado · ${s.Codigo||codigo} · x${s.Cantidad||cantidad}`);
          $('cantidad').value = 1;
          $('codigo').select();
        }catch(err){
          toast($('toastERR'), `Error: ${err.message}`);
        }
      });
    </script>
</body>
</html>
